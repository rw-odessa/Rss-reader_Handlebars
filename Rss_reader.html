<!doctype html>
<html lang="uk">
  <head>
    <meta charset="UTF-8">
    <title>Rss-reader on Handlebars</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.js"></script>
    
    <style>
      .table-striped:hover {
        cursor: pointer;
        cursor: hand;
      }
      a {
          font-size: 1.2em;
      }
    </style>
    
  </head>
  <body>
  
    <div class="page-header">
      <h1>Новини</h1>
    </div>
    
    <script id="rss-list" type="text/x-handlebars-template">
      {{#if channels}}
        <table class="table table-striped">
          <tbody>
            {{#each channels}}
                <tr onclick="show({{{json this}}})">
                  <td >{{channelName}}</td>
                </tr>
            {{/each}}
          </tbody>
        </table>
      {{else}}
        <p>Перелик каналов новин не визначено!</p>  
      {{/if}}
    </script>
    
    <script id="news-list" type="text/x-handlebars-template">
      {{#if entries}}
        {{#each entries}}
          <div class="panel panel-default">
            <div class="panel-body" onclick="showItem('#content-{{@index}}')">
            <!--div class="panel-body" onclick="showItem(this, {{{json this}}})"-->
              <!--div>{{publishedDate}} {{localTime publishedDate}}</div-->
              <!--div><strong>{{../title}}</strong> {{localTime publishedDate}}</div-->
              <!--div><strong>{{../channelName}}</strong> {{localTime publishedDate}}</div-->
              <div><strong>{{../channelName}}</strong> {{localTime2}}</div>
              {{#if author}}
                <div>
                  <strong>Автор: </strong>{{author}}
                </div>
              {{/if}}
              <a href="{{link}}" target="_blank" onclick="myEventHandler()">{{title}}</a>
              <!--div>{{{content}}}</div-->              
              <!--div><input type="Button" value="Детальніше..." onclick="showItem('#content-{{@index}}')"></input></div-->
              <div id="content-{{@index}}" style="display:none">{{{content}}}</div>
              
            </div>
          </div>
        {{/each}}
      {{else}}
          <p>Новини не завантажено!</p>  
      {{/if}}
    </script>
    
    <div id="cannelList" class="col-sm-2"></div>
    <div id="cannelContent" class="col-sm-10"></div>
    
    <script>
    'use strict';
      //<input type="Button" value="Показати" onclick="show({{{json this}}})"></input>
      Handlebars.registerHelper('json', function(context) {
        return JSON.stringify(context).replace(/"/g, '&quot;');
      });
      
      Handlebars.registerHelper('localTime', function(utcTime) {
        var itemTime;
        if (!utcTime) {
          itemTime = new Date();
        } else {
          itemTime = new Date(utcTime);
        }
        //var offset = new Date().getTimezoneOffset();
        //itemTime.setMinutes(itemTime.getMinutes() - offset);
        //console.log("itemTime - " + itemTime);
        //console.log("utcTime - " + utcTime);
        //console.log("LocaleDateString - " + itemTime.toLocaleDateString());
        //return itemTime.toISOString();
        return itemTime.toLocaleDateString() + " " + itemTime.toLocaleTimeString();
      });

      Handlebars.registerHelper('localTime2', function() {
        var itemTime;
        if (!this.publishedDate) {
          itemTime = new Date();
        } else {
          itemTime = new Date(this.publishedDate);
        }
        return itemTime.toLocaleDateString() + " " + itemTime.toLocaleTimeString();
      });
      
      window.onload = function () {
        //var source   = $("#rss-list").html();
        var source = document.getElementById("rss-list").innerHTML;
        var template = Handlebars.compile(source);
        var data = { channels: [
          //Тут редактируем список каналов новостей.
            {channelName: "ЦензорНЕТ", channelUrl: "http://censor.net.ua/includes/news_ru.xml"},
            {channelName: "Українська правда", channelUrl: "http://www.pravda.com.ua/rus/rss"},
            {channelName: "Новая газета", channelUrl: "http://www.novayagazeta.ru/rss/all.xml"},
            {channelName: "Независимая газета", channelUrl: "http://www.ng.ru/rss/"},
            {channelName: "Дзеркало тиждня", channelUrl: "http://dt.ua/rss/"},
            {channelName: "Апостроф", channelUrl: "http://apostrophe.com.ua/site/allfeed"},
            {channelName: "Аргумент", channelUrl: "http://argumentua.com/export.xml"},
            {channelName: "Корреспондент", channelUrl: "http://k.img.com.ua/rss/ua/all_news2.0.xml"},
            {channelName: "Подробности", channelUrl: "http://podrobnosti.ua/rss/feed/?category=all-news"},
            {channelName: "Сегодня UA", channelUrl: "http://www.segodnya.ua/xml/rss/specials.html"},
            //{channelName: "", channelUrl: ""},
            {channelName: "Сноб", channelUrl: "https://snob.ru/rss/all"},
            {channelName: "Коммерсант", channelUrl: "http://www.kommersant.ru/RSS/daily.xml"},
            {channelName: "UbuntuGeek", channelUrl: "http://feeds.feedburner.com/UbuntuGeek?format=xml"}
          ]};
        var cannelList = document.getElementById("cannelList");
        cannelList.innerHTML = template(data);
      };
      
      function show (channel) {
        $.ajax({
          url : 'http://ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=10&callback=?&q=' + encodeURIComponent(channel.channelUrl),
          dataType : 'json',
          success : function (data) {
            if (data.responseData.feed && data.responseData.feed.entries) {
              var source = document.getElementById("news-list").innerHTML;
              var template = Handlebars.compile(source);
              var feeds = data.responseData.feed;
              feeds.channelName = channel.channelName;
              //console.log(feeds);
              var cannelContent = document.getElementById("cannelContent");
              cannelContent.innerHTML = template(feeds);
              
              /*
              $.each(data.responseData.feed.entries, function (i, e) {
                console.log("------------------------");
                //console.log(e);
                //console.log("------------------------");
                console.log("title      : " + e.title);
                console.log("author     : " + e.author);
                console.log("description: " + e.description);
                var utc_date = new Date(e.publishedDate);
                var offset = new Date().getTimezoneOffset();
                utc_date.setMinutes(utc_date.getMinutes() - offset);
                //console.log("offset: " + offset);
                console.log(e.publishedDate + " " + utc_date.toISOString());
                console.log("Time + 3600: " + Date.parse(e.publishedDate) + 3600);
                console.log('Handlebars.templates - ' + JSON.stringify(Handlebars.templates));
              });
              */
              
            }
          }
        });
      };
      
      
      function showItem (id) {
 
        //console.log($(id).is(':visible'));
        //console.log($(id));
        /*
        if ($(id).is(':visible')) {
          $(id).hide(150);
        } else {
          $(id).show(150);
        }
        */
        var element = $(id);
        if (element.is(':visible')) {
          element.hide(150);
        } else {
          element.show(150);
        }
      }
      
      function myEventHandler(e)
      {
          if (!e)
            e = window.event;

          //IE9 & Other Browsers
          if (e.stopPropagation) {
            e.stopPropagation();
          }
          //IE8 and Lower
          else {
            e.cancelBubble = true;
          }
      }
      
    </script>
    
  </body>
</html>


